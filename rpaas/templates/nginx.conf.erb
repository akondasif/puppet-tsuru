user <%= @nginx_user %>;
worker_processes  <%= @nginx_worker_processes %>;

events {
    worker_connections  <%= @nginx_worker_connections %>;
}


http {
    include      mime.types;
    default_type application/octet-stream;

    sendfile          on;
    keepalive_timeout 65;

    log_format proxy '$remote_addr [$time_local] $request Local: $status $request_time $body_bytes_sent '
       'Proxy: $upstream_cache_status $upstream_status $upstream_response_time';

    access_log /var/log/nginx/proxy.log proxy;

    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=rpaas:10m max_size=10g loader_files=50;
    proxy_temp_path  /var/cache/nginx_temp 1 2;

    server {
        listen     <%= @nginx_admin_listen %>;
        server_name  _tsuru_nginx_admin;

        location /healthcheck {
            echo "WORKING";
        }

        location /reload {
            content_by_lua "ngx.print(os.execute('sudo service nginx reload'))";
        }

        location /dav {
<% @nginx_allow_dav_list.each do |ip| -%>
            allow           <%= ip %>;
<% end -%>
            deny            all;
            root            /etc/nginx/sites-enabled;
            dav_methods     PUT DELETE;
            create_full_put_path    on;
            dav_access      group:rw all:r;
        }
    }

    server {
        listen <%= @nginx_listen %>;
        listen <%= @nginx_ssl_listen %> ssl;

        ssl_certificate /etc/nginx/sites-enabled/dav/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/sites-enabled/dav/ssl/nginx.key;

        server_name  _tsuru_nginx_app;
        port_in_redirect off;

        proxy_cache rpaas;
        proxy_cache_use_stale error timeout updating invalid_header http_500 http_502 http_503 http_504;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_read_timeout 20s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 20s;
        proxy_http_version 1.1;

        location /_nginx_healthcheck/ {
            echo "WORKING";
        }

        include sites-enabled/dav/*.conf;
    }
}